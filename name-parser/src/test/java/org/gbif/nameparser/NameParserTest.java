package org.gbif.nameparser;

import org.apache.commons.io.LineIterator;
import org.apache.commons.lang3.time.StopWatch;
import org.gbif.nameparser.api.*;
import org.gbif.nameparser.api.ParsedName.State;
import org.junit.Ignore;
import org.junit.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.Reader;
import java.io.UnsupportedEncodingException;

import static org.gbif.nameparser.api.NamePart.INFRASPECIFIC;
import static org.gbif.nameparser.api.NameType.*;
import static org.gbif.nameparser.api.NomCode.BOTANICAL;
import static org.gbif.nameparser.api.NomCode.ZOOLOGICAL;
import static org.gbif.nameparser.api.Rank.*;
import static org.junit.Assert.*;

/**
 *
 */
public class NameParserTest {
  private static Logger LOG = LoggerFactory.getLogger(NameParserTest.class);
  static final NameParser parser = new NameParserGBIF();

  @Test
  public void parseSpecies() throws Exception {

    assertName("Zophosis persis (Chatanay 1914)", "Zophosis persis")
        .species("Zophosis", "persis")
        .basAuthors("1914", "Chatanay")
        .nothingElse();

    assertName("Abies alba Mill.", "Abies alba")
        .species("Abies", "alba")
        .combAuthors(null, "Mill.")
        .nothingElse();

    assertName("Alstonia vieillardii Van Heurck & Müll.Arg.", "Alstonia vieillardii")
        .species("Alstonia", "vieillardii")
        .combAuthors(null, "Van Heurck", "Müll.Arg.")
        .nothingElse();

    assertName("Angiopteris d'urvilleana de Vriese", "Angiopteris d'urvilleana")
        .species("Angiopteris", "d'urvilleana")
        .combAuthors(null, "de Vriese")
        .nothingElse();

    assertName("Agrostis hyemalis (Walter) Britton, Sterns, & Poggenb.", "Agrostis hyemalis")
        .species("Agrostis", "hyemalis")
        .combAuthors(null, "Britton", "Sterns", "Poggenb.")
        .basAuthors(null, "Walter")
        .nothingElse();
  }

  @Test
  public void parseCapitalAuthors() throws Exception {
    assertName("Anniella nigra FISCHER 1885", "Anniella nigra")
        .species("Anniella", "nigra")
        .combAuthors("1885", "Fischer")
        .nothingElse();
  }

  @Test
  public void parseAuthorPrefixes() throws Exception {
    assertName("Hieracium scorzoneraefolium De la Soie", "Hieracium scorzoneraefolium")
        .species("Hieracium", "scorzoneraefolium")
        .combAuthors(null, "De la Soie")
        .nothingElse();
  }

  @Test
  public void parseInfraSpecies() throws Exception {

    assertName("Abies alba ssp. alpina Mill.", "Abies alba subsp. alpina")
        .infraSpecies("Abies", "alba", SUBSPECIES, "alpina")
        .combAuthors(null, "Mill.")
        .nothingElse();

    assertName("Festuca ovina L. subvar. gracilis Hackel", "Festuca ovina subvar. gracilis")
        .infraSpecies("Festuca", "ovina", SUBVARIETY, "gracilis")
        .combAuthors(null, "Hackel")
        .nothingElse();

    assertName("Pseudomonas syringae pv. aceris (Ark, 1939) Young, Dye & Wilkie, 1978", "Pseudomonas syringae pv. aceris")
        .infraSpecies("Pseudomonas", "syringae", PATHOVAR, "aceris")
        .combAuthors("1978", "Young", "Dye", "Wilkie")
        .basAuthors("1939", "Ark");

    assertName("Agaricus compactus sarcocephalus (Fr.) Fr. ", "Agaricus compactus sarcocephalus")
        .infraSpecies("Agaricus", "compactus", INFRASPECIFIC_NAME, "sarcocephalus")
        .combAuthors(null, "Fr.")
        .basAuthors(null, "Fr.")
        .nothingElse();

    assertName("Baccharis microphylla Kunth var. rhomboidea Wedd. ex Sch. Bip. (nom. nud.)", "Baccharis microphylla var. rhomboidea")
        .infraSpecies("Baccharis", "microphylla", VARIETY, "rhomboidea")
        .combAuthors(null, "Sch.Bip.")
        .combExAuthors("Wedd.")
        .nomNote("nom. nud.")
        .nothingElse();

  }

  @Test
  public void testExAuthors() throws Exception {
    // In botany (99% of ex author use) the ex author comes first, see https://en.wikipedia.org/wiki/Author_citation_(botany)#Usage_of_the_term_.22ex.22
    assertName("Baccharis microphylla Kunth var. rhomboidea Wedd. ex Sch. Bip. (nom. nud.)", "Baccharis microphylla var. rhomboidea")
        .infraSpecies("Baccharis", "microphylla", VARIETY, "rhomboidea")
        .combAuthors(null, "Sch.Bip.")
        .combExAuthors("Wedd.")
        .nomNote("nom. nud.")
        .nothingElse();

    assertName("Abutilon bastardioides Baker f. ex Rose", "Abutilon bastardioides")
        .species("Abutilon", "bastardioides")
        .combAuthors(null, "Rose")
        .combExAuthors("Baker f.")
        .nothingElse();

    assertName("Abutilon bastardioides Baker f. ex Rose", "Abutilon bastardioides")
        .species("Abutilon", "bastardioides")
        .combAuthors(null, "Rose")
        .combExAuthors("Baker f.")
        .nothingElse();

    // "Abies brevifolia cv. ex Dallim."
    // "Abies brevifolia hort. ex Dallim."
    // "Acacia truncata (Burm. f.) hort. ex Hoffmanns."
    // "Anoectocalyx ex Cogn. 'Triana'"
    // "Anoectocalyx \"Triana\" ex Cogn.  "
    // "Aukuba ex Koehne 'Thunb'   "
    // "Abutilon ×hybridum cv. ex Voss"
  }

  @Test
  public void test4PartedNames() throws Exception {
    assertName("Bombus sichelii alticola latofasciatus", "Bombus sichelii latofasciatus")
        .infraSpecies("Bombus", "sichelii", INFRASUBSPECIFIC_NAME, "latofasciatus")
        .nothingElse();

    assertName("Poa pratensis kewensis primula (L.) Rouy, 1913", "Poa pratensis primula")
        .infraSpecies("Poa", "pratensis", INFRASUBSPECIFIC_NAME, "primula")
        .combAuthors("1913", "Rouy")
        .basAuthors(null, "L.")
        .nothingElse();

    assertName("Acipenser gueldenstaedti colchicus natio danubicus Movchan, 1967", "Acipenser gueldenstaedti natio danubicus")
        .infraSpecies("Acipenser", "gueldenstaedti", NATIO, "danubicus")
        .combAuthors("1967", "Movchan")
        .code(ZOOLOGICAL)
        .nothingElse();
  }

  @Test
  public void parseMonomial() throws Exception {

    assertName("Acripeza Guérin-Ménéville 1838", "Acripeza")
        .monomial("Acripeza")
        .combAuthors("1838", "Guérin-Ménéville")
        .nothingElse();

  }

  @Test
  public void parseInfraGeneric() throws Exception {
    assertName("Echinocereus sect. Triglochidiata Bravo", "Echinocereus sect. Triglochidiata")
        .infraGeneric("Echinocereus", SECTION, "Triglochidiata")
        .combAuthors(null, "Bravo")
        .code(BOTANICAL)
        .nothingElse();

    assertName("Zignoella subgen. Trematostoma Sacc.", "Zignoella subgen. Trematostoma")
        .infraGeneric("Zignoella", SUBGENUS, "Trematostoma")
        .combAuthors(null, "Sacc.")
        .nothingElse();

    assertName("subgen. Trematostoma Sacc.", "Trematostoma")
        .monomial("Trematostoma", SUBGENUS)
        .combAuthors(null, "Sacc.")
        .nothingElse();

    assertName("Polygonum subgen. Bistorta (L.) Zernov", "Polygonum subgen. Bistorta")
        .infraGeneric("Polygonum", SUBGENUS, "Bistorta")
        .combAuthors(null, "Zernov")
        .basAuthors(null, "L.")
        .nothingElse();

    assertName("Arrhoges (Antarctohoges)", "Arrhoges")
        .monomial("Arrhoges")
        .basAuthors(null, "Antarctohoges")
        .nothingElse();

    assertName("Arrhoges (Antarctohoges)", SUBGENUS,"Arrhoges subgen. Antarctohoges")
        .infraGeneric("Arrhoges", SUBGENUS, "Antarctohoges")
        .nothingElse();

    assertName("Festuca subg. Schedonorus (P. Beauv. ) Peterm.","Festuca subgen. Schedonorus")
        .infraGeneric("Festuca", SUBGENUS, "Schedonorus")
        .combAuthors(null, "Peterm.")
        .basAuthors(null, "P.Beauv.")
        .nothingElse();

    assertName("Catapodium subg.Agropyropsis  Trab.", "Catapodium subgen. Agropyropsis")
        .infraGeneric("Catapodium", SUBGENUS, "Agropyropsis")
        .combAuthors(null, "Trab.")
        .nothingElse();

    assertName(" Gnaphalium subg. Laphangium Hilliard & B. L. Burtt", "Gnaphalium subgen. Laphangium")
        .infraGeneric("Gnaphalium", SUBGENUS, "Laphangium")
        .combAuthors(null, "Hilliard", "B.L.Burtt")
        .nothingElse();

    assertName("Woodsiaceae (Hooker) Herter", "Woodsiaceae")
        .monomial("Woodsiaceae", FAMILY)
        .combAuthors(null, "Herter")
        .basAuthors(null, "Hooker")
        .nothingElse();
  }

  @Test
  public void testNotNames() throws Exception {
    assertName("Diatrypella favacea var. favacea (Fr.) Ces. & De Not.", "Diatrypella favacea var. favacea")
        .infraSpecies("Diatrypella", "favacea", VARIETY, "favacea")
        .combAuthors(null, "Ces.", "De Not.")
        .basAuthors(null, "Fr.")
        .nothingElse();

    assertName("Protoventuria rosae (De Not.) Berl. & Sacc.", "Protoventuria rosae")
        .species("Protoventuria", "rosae")
        .combAuthors(null, "Berl.", "Sacc.")
        .basAuthors(null, "De Not.")
        .nothingElse();

    assertName("Hormospora De Not.", "Hormospora")
        .monomial("Hormospora")
        .combAuthors(null, "De Not.")
        .nothingElse();
  }

  @Test
  public void unparsablePlaceholder() throws Exception {
    assertUnparsable("[unassigned] Cladobranchia", PLACEHOLDER);

    assertUnparsable("Biota incertae sedis", PLACEHOLDER);

    assertUnparsable("Mollusca not assigned", PLACEHOLDER);

    assertUnparsable("Unaccepted", PLACEHOLDER);
  }

  @Test
  public void parsePlaceholder() throws Exception {
    assertName("\"? gryphoidis", "? gryphoidis")
        .species("?", "gryphoidis")
        .type(PLACEHOLDER)
        .nothingElse();

    assertName("\"? gryphoidis (Bourguignat 1870) Schoepf. 1909", "? gryphoidis")
        .species("?", "gryphoidis")
        .basAuthors("1870", "Bourguignat")
        .combAuthors("1909", "Schoepf.")
        .type(PLACEHOLDER)
        .nothingElse();

    assertName("Missing penchinati Bourguignat, 1870", "? penchinati")
        .species("?", "penchinati")
        .combAuthors("1870", "Bourguignat")
        .type(PLACEHOLDER)
        .nothingElse();
  }

  @Test
  public void parseSanctioned() throws Exception {
    // sanctioning authors not supported
    // https://github.com/GlobalNamesArchitecture/gnparser/issues/409
    assertName("Boletus versicolor L. : Fr.", "Boletus versicolor")
        .species("Boletus", "versicolor")
        .combAuthors(null, "L.")
        .sanctAuthor("Fr.")
        .nothingElse();

    assertName("Agaricus compactus sarcocephalus (Fr. : Fr.) Fr. ", "Agaricus compactus sarcocephalus")
        .infraSpecies("Agaricus", "compactus", INFRASPECIFIC_NAME, "sarcocephalus")
        .combAuthors(null, "Fr.")
        .basAuthors(null, "Fr.")
        .nothingElse();

    assertName("Agaricus compactus sarcocephalus (Fr. : Fr.) Fr. ", "Agaricus compactus sarcocephalus")
        .infraSpecies("Agaricus", "compactus", INFRASPECIFIC_NAME, "sarcocephalus")
        .combAuthors(null, "Fr.")
        .basAuthors(null, "Fr.")
        .nothingElse();
  }

  @Test
  public void parseNothotaxa() throws Exception {
    // https://github.com/GlobalNamesArchitecture/gnparser/issues/410
    assertName("Iris germanica nothovar. florentina", "Iris germanica nothovar. florentina")
        .infraSpecies("Iris", "germanica", VARIETY, "florentina")
        .notho(INFRASPECIFIC)
        .nothingElse();

    assertName("Abies alba var. ×alpina L.", "Abies alba nothovar. alpina")
        .infraSpecies("Abies", "alba", VARIETY, "alpina")
        .notho(INFRASPECIFIC)
        .combAuthors(null, "L.")
        .nothingElse();
  }


  @Test
  public void testCandidatus() throws Exception {
    assertName("\"Candidatus Endowatersipora\" Anderson and Haygood, 2007", "\"Candidatus Endowatersipora\"")
        .monomial("Endowatersipora")
        .candidatus()
        .combAuthors("2007", "Anderson", "Haygood")
        .nothingElse();

    assertName("Candidatus Phytoplasma allocasuarinae", "\"Candidatus Phytoplasma allocasuarinae\"")
        .species("Phytoplasma", "allocasuarinae")
        .candidatus()
        .nothingElse();

    assertName("Ca. Phytoplasma allocasuarinae", "\"Candidatus Phytoplasma allocasuarinae\"")
        .species("Phytoplasma", "allocasuarinae")
        .candidatus()
        .nothingElse();

    assertName("Ca. Phytoplasma", "\"Candidatus Phytoplasma\"")
        .monomial("Phytoplasma")
        .candidatus()
        .nothingElse();

    assertName("'Candidatus Nicolleia'", "\"Candidatus Nicolleia\"")
        .monomial("Nicolleia")
        .candidatus()
        .nothingElse();

    assertName("\"Candidatus Riegeria\" Gruber-Vodicka et al., 2011", "\"Candidatus Riegeria\"")
        .monomial("Riegeria")
        .combAuthors("2011", "Gruber-Vodicka", "al.")
        .candidatus()
        .nothingElse();

    assertName("Candidatus Endobugula", "\"Candidatus Endobugula\"")
        .monomial("Endobugula")
        .candidatus()
        .nothingElse();

    // not candidate names
    assertName("Centropogon candidatus Lammers", "Centropogon candidatus")
        .species("Centropogon", "candidatus")
        .combAuthors(null, "Lammers")
        .nothingElse();
  }

  @Test
  @Ignore
  public void testStrains() throws Exception {
    assertName("Endobugula sp. JYr4", "Endobugula sp. JYr4")
        .species("Endobugula", null)
        .strain("sp. JYr4")
        .nothingElse();

    // avoid author & year to be accepted as strain
    assertName("Anniella nigra FISCHER 1885", "Anniella nigra")
        .species("Anniella", "nigra")
        .combAuthors("1885", "Fischer")
        .nothingElse();
  }

  /**
   * Not sure what to do with these names.
   * They look broken.
   *
   * @see <a href="http://dev.gbif.org/issues/browse/GBIFCOM-11">GBIFCOM-11</a>
   */
  @Test
  @Ignore
  public void testExNames() throws Exception {
    // "Abies brevifolia cv. ex Dallim."
    // "Abies brevifolia hort. ex Dallim."
    // "Abutilon bastardioides Baker f. ex Rose"
    // "Acacia truncata (Burm. f.) hort. ex Hoffmanns."
    // "Anoectocalyx ex Cogn. 'Triana'"
    // "Anoectocalyx \"Triana\" ex Cogn.  "
    // "Aukuba ex Koehne 'Thunb'   "
    // "Crepinella subgen. Marchal ex Oliver  "
    // "Echinocereus sect. Triglochidiata ex Bravo"
    // "Hadrolaelia sect. Sophronitis ex Chiron & V.P.Castro"
    // "Abutilon ×hybridum cv. ex Voss"
  }

  @Test
  public void parseNorwegianRadiolaria() throws Exception {
    assertName("Actinomma leptodermum longispinum Cortese & Bjørklund 1998", "Actinomma leptodermum longispinum")
        .infraSpecies("Actinomma", "leptodermum", INFRASPECIFIC_NAME, "longispinum")
        .combAuthors("1998", "Cortese", "Bjørklund")
        .nothingElse();

    assertName("Arachnosphaera dichotoma  Jørgensen, 1900", "Arachnosphaera dichotoma")
        .species("Arachnosphaera", "dichotoma")
        .combAuthors("1900", "Jørgensen")
        .nothingElse();

    assertName("Hexaconthium pachydermum forma legitime Cortese & Bjørklund 1998","Hexaconthium pachydermum f. legitime")
        .infraSpecies("Hexaconthium", "pachydermum", FORM, "legitime")
        .combAuthors("1998", "Cortese", "Bjørklund")
        .nothingElse();

    assertName("Hexaconthium pachydermum form A Cortese & Bjørklund 1998","Hexaconthium pachydermum f. A")
        .infraSpecies("Hexaconthium", "pachydermum", FORM, "A")
        .combAuthors("1998", "Cortese", "Bjørklund")
        .type(INFORMAL)
        .nothingElse();

    assertName("Trisulcus aff. nana  (Popofsky, 1913), Petrushevskaya, 1971", "Trisulcus nana")
        .species("Trisulcus", "nana")
        .basAuthors("1913", "Popofsky")
        .combAuthors("1971", "Petrushevskaya")
        .type(INFORMAL)
        .nothingElse();

    assertName("Tripodiscium gephyristes  (Hülseman, 1963) BJ&KR-Atsdatabanken", "Tripodiscium gephyristes")
        .species("Tripodiscium", "gephyristes")
        .basAuthors("1963", "Hülseman")
        .combAuthors(null, "BJ", "KR-Atsdatabanken")
        .nothingElse();

    assertName("Protocystis xiphodon  (Haeckel, 1887), Borgert, 1901", "Protocystis xiphodon")
        .species("Protocystis", "xiphodon")
        .basAuthors("1887", "Haeckel")
        .combAuthors("1901", "Borgert")
        .nothingElse();

    assertName("Acrosphaera lappacea  (Haeckel, 1887) Takahashi, 1991", "Acrosphaera lappacea")
        .species("Acrosphaera", "lappacea")
        .basAuthors("1887", "Haeckel")
        .combAuthors("1991", "Takahashi")
        .nothingElse();
  }

  @Test
  public void parseCultivars() throws Exception {
    // fix cultivar names
    assertName("Acer campestre L. cv. 'nanum'", "Acer campestre 'nanum'")
        .cultivar("Acer", "campestre", "nanum")
        .combAuthors(null, "L.")
        .nothingElse();

    assertName("Verpericola megasoma \"Dall\" Pils.", "Verpericola megasoma 'Dall'")
        .cultivar("Verpericola", "megasoma", "Dall")
        .combAuthors(null, "Pils.")
        .nothingElse();

    assertName("Abutilon 'Kentish Belle'", "Abutilon 'Kentish Belle'")
        .cultivar("Abutilon", "Kentish Belle")
        .nothingElse();

    assertName("Abutilon 'Nabob'", "Abutilon 'Nabob'")
        .cultivar("Abutilon", "Nabob")
        .nothingElse();

    assertName("Sorbus americana Marshall cv. 'Belmonte'", "Sorbus americana 'Belmonte'")
        .cultivar("Sorbus", "americana", "Belmonte")
        .combAuthors(null, "Marshall")
        .nothingElse();

    assertName("Sorbus hupehensis C.K.Schneid. cv. 'November pink'", "Sorbus hupehensis 'November pink'")
        .cultivar("Sorbus", "hupehensis", "November pink")
        .combAuthors(null, "C.K.Schneid.")
        .nothingElse();

    assertName("Symphoricarpos albus (L.) S.F.Blake cv. 'Turesson'", "Symphoricarpos albus 'Turesson'")
        .cultivar("Symphoricarpos", "albus", CULTIVAR, "Turesson")
        .basAuthors(null, "L.")
        .combAuthors(null, "S.F.Blake")
        .nothingElse();

    assertName("Symphoricarpos sp. cv. 'mother of pearl'", "Symphoricarpos 'mother of pearl'")
        .cultivar("Symphoricarpos", CULTIVAR, "mother of pearl")
        .nothingElse();

    assertName("Primula Border Auricula Group", "Primula Border Auricula Group")
        .cultivar("Primula", CULTIVAR_GROUP, "Border Auricula")
        .nothingElse();

    assertName("Rhododendron boothii Mishmiense Group", "Rhododendron boothii Mishmiense Group")
        .cultivar("Rhododendron", "boothii", CULTIVAR_GROUP, "Mishmiense")
        .nothingElse();

    assertName("Paphiopedilum Sorel grex", "Paphiopedilum Sorel gx")
        .cultivar("Paphiopedilum", GREX, "Sorel")
        .nothingElse();

    assertName("Cattleya Prince John gx", "Cattleya Prince John gx")
        .cultivar("Cattleya", GREX, "Prince John")
        .nothingElse();
  }

  @Test
  public void timeoutLongNames() throws Exception {
    final int timeout = 5;
    NameParser quickParser = new NameParserGBIF(timeout);
    StopWatch watch = new StopWatch();
    // warm up parser
    try {
      quickParser.parse("Abies", Rank.GENUS);
    } catch (UnparsableNameException ex) {
      // too short on your machine? ignore
    }

    String name = "Desmarestia ligulata subsp. muelleri (M.E.Ramirez & A.F.Peters) S.S.Y. Wong, A.H.Y. Ngan, Riggs, J.L.L. Teng, A.F.Peters, E.C.Yang, A.F.Peters, E.C.Yang, F.C.Küpper & Prud'Homme van Reine, 2014";
    watch.start();
    try {
      quickParser.parse(name);
      fail("Expected to be unparsable: "+name);

    } catch (UnparsableNameException ex) {

      final long duration = watch.getTime();
      System.out.println("Parsing took "+duration+"ms");
      // the duration is the timeout PLUS some initialization overhead thats why we allow 25ms for
      assertTrue("No timeout happening for long running parsing ("+duration+"ms)", duration < 25 + timeout);
      assertEquals(NameType.SCIENTIFIC, ex.getType());
      assertEquals(name, ex.getName());
    }


    //TODO
  }

  @Test
  public void testHybridFormulas() throws Exception {
    assertHybridFormula("Asplenium rhizophyllum DC. x ruta-muraria E.L. Braun 1939");
    assertHybridFormula("Arthopyrenia hyalospora X Hydnellum scrobiculatum");
    assertHybridFormula("Arthopyrenia hyalospora (Banker) D. Hall X Hydnellum scrobiculatum D.E. Stuntz");
    assertHybridFormula("Arthopyrenia hyalospora × ? ");
    assertHybridFormula("Agrostis L. × Polypogon Desf. ");
    assertHybridFormula("Agrostis stolonifera L. × Polypogon monspeliensis (L.) Desf. ");
    assertHybridFormula("Asplenium rhizophyllum X A. ruta-muraria E.L. Braun 1939");
    assertHybridFormula("Asplenium rhizophyllum DC. x ruta-muraria E.L. Braun 1939");
    assertHybridFormula("Asplenium rhizophyllum x ruta-muraria");
    assertHybridFormula("Salix aurita L. × S. caprea L.");
    assertHybridFormula("Mentha aquatica L. × M. arvensis L. × M. spicata L.");
    assertHybridFormula("Polypodium vulgare subsp. prionodes (Asch.) Rothm. × subsp. vulgare");
    assertHybridFormula("Tilletia caries (Bjerk.) Tul. × T. foetida (Wallr.) Liro.");

    assertName("Polypodium  x vulgare nothosubsp. mantoniae (Rothm.) Schidlay", "Polypodium vulgare nothosubsp. mantoniae")
        .infraSpecies("Polypodium", "vulgare", SUBSPECIES, "mantoniae")
        .basAuthors(null, "Rothm.")
        .combAuthors(null, "Schidlay")
        .notho(INFRASPECIFIC)
        .nothingElse();
  }

  private void assertHybridFormula(String name) {
    assertUnparsable(name, HYBRID_FORMULA);
  }

  @Test
  public void testOTU() throws Exception {
    assertName("BOLD:ACW2100", "BOLD:ACW2100")
        .monomial("BOLD:ACW2100", Rank.SPECIES)
        .type(OTU)
        .state(State.NAME_ONLY)
        .nothingElse();

    assertName("Festuca sp. BOLD:ACW2100", "BOLD:ACW2100")
        .monomial("BOLD:ACW2100", Rank.SPECIES)
        .type(OTU)
        .state(State.NAME_ONLY)
        .nothingElse();

    // no OTU names
    assertName("Boldenaria", "Boldenaria")
        .monomial("Boldenaria")
        .nothingElse();

    assertName("Boldea", "Boldea")
        .monomial("Boldea")
        .nothingElse();

    assertName("Boldiaceae", "Boldiaceae")
        .monomial("Boldiaceae", Rank.FAMILY)
        .nothingElse();

    assertName("Boldea vulgaris", "Boldea vulgaris")
        .species("Boldea", "vulgaris")
        .nothingElse();
  }

  @Test
  public void testHybridAlikeNames() throws Exception {
    assertName("Huaiyuanella Xing, Yan & Yin, 1984", "Huaiyuanella")
        .monomial("Huaiyuanella")
        .combAuthors("1984", "Xing", "Yan", "Yin")
        .nothingElse();

    assertName("Caveasphaera Xiao & Knoll, 2000", "Caveasphaera")
        .monomial("Caveasphaera")
        .combAuthors("2000", "Xiao", "Knoll")
        .nothingElse();
  }

  @Test
  @Ignore("Need to evaluate and implement these alpha/beta/gamme/theta names. Comes from cladistics?")
  public void testAlphaBetaThetaNames() {
    // 11383509 | VARIETY | Trianosperma ficifolia var. βrigida Cogn.
    // 11599666 |         | U. caerulea var. β
    // 12142976 | CLASS   | γ Proteobacteria
    // 12142978 | CLASS   | γ-proteobacteria
    // 16220269 |         | U. caerulea var. β
    // 1297218  | SPECIES | Bacteriophage Qβ
    // 307122   | SPECIES | Agaricus collinitus β mucosus (Bull.) Fr.
    // 313460   | SPECIES | Agaricus muscarius β regalis Fr. (1821)
    // 315162   | SPECIES | Agaricus personatus β saevus
    // 1774875  | VARIETY | Caesarea albiflora var. βramosa Cambess.
    // 3164679  | VARIETY | Cyclotus amethystinus var. α Guppy, 1868 (in part)
    // 3164681  | VARIETY | Cyclotus amethystinus var. β Guppy, 1868
    // 6531344  | SPECIES | Lycoperdon pyriforme β tessellatum Pers. (1801)
    // 7487686  | VARIETY | Nephilengys malabarensis var. β
    // 9665391  | VARIETY | Ranunculus purshii Hook. var. repens(-δ) Hook.
  }

  @Test
  public void testHybridNames() throws Exception {
    assertName("+ Pyrocrataegus willei L.L.Daniel", "× Pyrocrataegus willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.GENERIC)
        .nothingElse();

    assertName("×Pyrocrataegus willei L.L. Daniel", "× Pyrocrataegus willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.GENERIC)
        .nothingElse();

    assertName(" × Pyrocrataegus willei  L. L. Daniel", "× Pyrocrataegus willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.GENERIC)
        .nothingElse();

    assertName(" X Pyrocrataegus willei L. L. Daniel", "× Pyrocrataegus willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.GENERIC)
        .nothingElse();

    assertName("Pyrocrataegus ×willei L. L. Daniel", "Pyrocrataegus × willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.SPECIFIC)
        .nothingElse();

    assertName("Pyrocrataegus × willei L. L. Daniel", "Pyrocrataegus × willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.SPECIFIC)
        .nothingElse();

    assertName("Pyrocrataegus x willei L. L. Daniel", "Pyrocrataegus × willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.SPECIFIC)
        .nothingElse();

    assertName("Pyrocrataegus X willei L. L. Daniel", "Pyrocrataegus × willei")
        .species("Pyrocrataegus", "willei")
        .combAuthors(null, "L.L.Daniel")
        .notho(NamePart.SPECIFIC)
        .nothingElse();

    assertName("Pyrocrataegus willei ×libidi  L.L.Daniel", "Pyrocrataegus willei × libidi")
        .infraSpecies("Pyrocrataegus", "willei", INFRASPECIFIC_NAME, "libidi")
        .combAuthors(null, "L.L.Daniel")
        .notho(INFRASPECIFIC)
        .nothingElse();

    assertName("Pyrocrataegus willei nothosubsp. libidi  L.L.Daniel", "Pyrocrataegus willei nothosubsp. libidi")
        .infraSpecies("Pyrocrataegus", "willei", SUBSPECIES, "libidi")
        .combAuthors(null, "L.L.Daniel")
        .notho(INFRASPECIFIC)
        .nothingElse();

    assertName("+ Pyrocrataegus willei nothosubsp. libidi  L.L.Daniel", "Pyrocrataegus willei nothosubsp. libidi")
        .infraSpecies("Pyrocrataegus", "willei", SUBSPECIES, "libidi")
        .combAuthors(null, "L.L.Daniel")
        .notho(INFRASPECIFIC)
        .nothingElse();

    //TODO: impossible name. should this not be a generic hybrid as its the highest rank crossed?
    assertName("×Pyrocrataegus ×willei ×libidi L.L.Daniel", "Pyrocrataegus willei × libidi")
        .infraSpecies("Pyrocrataegus", "willei", INFRASPECIFIC_NAME, "libidi")
        .combAuthors(null, "L.L.Daniel")
        .notho(INFRASPECIFIC)
        .nothingElse();

  }

  @Test
  public void testApostropheAuthors() throws Exception {
    assertName("Cirsium creticum d'Urv.", "Cirsium creticum")
        .species("Cirsium", "creticum")
        .combAuthors(null, "d'Urv.")
        .nothingElse();

    // TODO: autonym authors are the species authors !!!
    assertName("Cirsium creticum d'Urv. subsp. creticum", "Cirsium creticum subsp. creticum")
        .infraSpecies("Cirsium", "creticum", SUBSPECIES, "creticum")
        //.combAuthors(null, "d'Urv.")
        .autonym()
        .nothingElse();
  }

  @Test
  public void testExtinctNames() throws Exception {
    assertName("†Titanoptera", "Titanoptera")
        .monomial("Titanoptera")
        .nothingElse();

    assertName("† Tuarangiida MacKinnon, 1982", "Tuarangiida")
        .monomial("Tuarangiida")
        .combAuthors("1982", "MacKinnon")
        .nothingElse();
  }

  @Test
  @Ignore("To be implemented")
  public void testNonNames() throws Exception {
    assertName("Lindera Thunb. non Adans. 1763", "Lindera")
        .monomial("Lindera")
        .combAuthors(null, "Thunb.")
        .sensu("non Adans. 1763")
        .nothingElse();

    assertName("Lindera Thunb., Nov. Gen. Pl.: 64. 1783, non Adans. 1763", "Lindera")
        .monomial("Lindera")
        .combAuthors(null, "Thunb.")
        .nothingElse();

    assertName("Bartlingia Brongn. in Ann. Sci. Nat. (Paris) 10: 373. 1827, non Rchb. 1824 nec F.Muell. 1882", "Bartlingia")
        .monomial("Bartlingia")
        .combAuthors(null, "Brongn.")
        .nothingElse();

    assertName("Nitocris (Nitocris) similis Breuning, 1956 (nec Gahan, 1893)", "Nitocris similis")
        .species("Nitocris", "similis")
        .combAuthors("1956", "Breuning")
        .nothingElse();
  }

  @Test
  public void testMisapplied() throws Exception {
    assertName("Ficus exasperata auct. non Vahl", "Ficus exasperata")
        .species("Ficus", "exasperata")
        .sensu("auct. non Vahl")
        .nothingElse();
  }

  /**
   * Simply test all names in names.txt and make sure they parse without exception.
   * This test does not verify if the parsed name was correct in all its pieces,
   * so only use this as a quick way to add names to tests.
   *
   * Exceptional cases should better be tested in a test on its own!
   */
  @Test
  public void testNameFile() throws Exception {
    Reader reader = resourceReader("names.txt");
    LineIterator iter = new LineIterator(reader);
    while (iter.hasNext()) {
      String line = iter.nextLine();
      if (line == null || line.startsWith("#") || line.trim().isEmpty()) {
        continue;
      }
      ParsedName n = parser.parse(line, null);
      assertTrue(n.getState().isAuthorshipParsed());
    }
  }

  /**
   * Expect empty unparsable results for nothing or whitespace
   */
  @Test
  public void testEmpty() throws Exception {
    assertEmptyName(null);
    assertEmptyName("");
    assertEmptyName(" ");
    assertEmptyName("\t");
    assertEmptyName("\n");
    assertEmptyName("\t\n");
    // TODO: should this be no name instead ???
    assertEmptyName("\"");
    assertEmptyName("'");
  }

  /**
   * Avoid NPEs and other exceptions for very short non names and other extremes found in occurrences.
   */
  @Test
  public void testAvoidNPE() throws Exception {
    assertNoName("\\");
    assertNoName(".");
    assertNoName("@");
    assertNoName("&nbsp;");
    assertNoName("X");
    assertNoName("a");
    assertNoName("von");
    assertNoName("143");
    assertNoName("321-432");
    assertNoName("-,.#");
    assertNoName(" .");
  }

  @Test
  public void testStringIndexOutOfBoundsException() throws Exception {
    parser.parse("Amblyomma americanum (Linnaeus, 1758)", null);
    parser.parse("Salix taiwanalpina var. chingshuishanensis (S.S.Ying) F.Y.Lu, C.H.Ou, Y.C.Chen, Y.S.Chi, K.C.Lu & Y.H.Tseng ", null);
    parser.parse("Salix taiwanalpina var. chingshuishanensis (S.S.Ying) F.Y.Lu, C.H.Ou, Y.C.Chen, Y.S.Chi, K.C.Lu & amp  Y.H.Tseng ", null);
    parser.parse("Salix morrisonicola var. takasagoalpina (Koidz.) F.Y.Lu, C.H.Ou, Y.C.Chen, Y.S.Chi, K.C.Lu & amp; Y.H.Tseng", null);
    parser.parse("Ficus ernanii Carauta, Pederneir., P.P.Souza, A.F.P.Machado, M.D.M.Vianna & amp; Romaniuc", null);
  }

  @Test
  public void testSensuParsing() throws Exception {
    assertEquals("sensu Baker f.", parser.parse("Trifolium repens sensu Baker f.", null).getSensu());
    assertEquals("sensu latu", parser.parse("Achillea millefolium sensu latu", null).getSensu());
    assertEquals("sec. Greuter, 2009", parser.parse("Achillea millefolium sec. Greuter 2009", null).getSensu());
  }

  @Test
  @Ignore
  public void testOccNameFile() throws Exception {
    Reader reader = resourceReader("occurrence-names.txt");
    LineIterator iter = new LineIterator(reader);

    int parseFails = 0;
    int parseAuthorless = 0;
    int lineNum = 0;
    long start = System.currentTimeMillis();

    while (iter.hasNext()) {
      lineNum++;
      String name = iter.nextLine();
      ParsedName n;
      try {
        n = parser.parse(name, null);
        if (!n.getState().isAuthorshipParsed()) {
          parseAuthorless++;
          LOG.warn("NO AUTHORS\t " + name);
        }
      } catch (UnparsableNameException e) {
        parseFails++;
        LOG.warn("FAIL\t " + name);
      }
    }
    long end = System.currentTimeMillis();
    LOG.info("\n\nNames tested: " + lineNum);
    LOG.info("Names parse fail: " + parseFails);
    LOG.info("Names parse no authors: " + parseAuthorless);
    LOG.info("Total time: " + (end - start));
    LOG.info("Average per name: " + (((double) end - start) / lineNum));

    int currFail = 2;
    if ((parseFails) > currFail) {
      fail("We are getting worse, not better. Currently failing: " + (parseFails) + ". Was passing:" + currFail);
    }
    int currNoAuthors = 109;
    if ((parseAuthorless) > currNoAuthors) {
      fail(
          "We are getting worse, not better. Currently without authors: " + (parseAuthorless) + ". Was:" + currNoAuthors);
    }
  }

  @Test
  public void testViralNames() throws Exception {
    assertTrue(isViralName("Vibrio phage 149 (type IV)"));
    assertTrue(isViralName("Cactus virus 2"));
    assertTrue(isViralName("Suid herpesvirus 3 Ictv"));
    assertTrue(isViralName("Tomato yellow leaf curl Mali virus Ictv"));
    assertTrue(isViralName("Not Sapovirus MC10"));
    assertTrue(isViralName("Diolcogaster facetosa bracovirus"));
    assertTrue(isViralName("Human papillomavirus"));
    assertTrue(isViralName("Sapovirus Hu/GI/Nsc, 150/PA/Bra/, 1993"));
    assertTrue(isViralName("Aspergillus mycovirus, 1816"));
    assertTrue(isViralName("Hantavirus sdp2 Yxl-, 2008"));
    assertTrue(isViralName("Norovirus Nizhny Novgorod /, 2461 / Rus /, 2007"));
    assertTrue(isViralName("Carrot carlavirus WM-, 2008"));
    assertTrue(isViralName("C2-like viruses"));
    assertTrue(isViralName("C1 bacteriophage"));
    assertTrue(isViralName("C-terminal Gfp fusion vector pUG23"));
    assertTrue(isViralName("C-terminal Gfp fusion vector"));
    assertTrue(isViralName("CMVd3 Flexi Vector pFN24K (HaloTag 7)"));
    assertTrue(isViralName("bacteriophage, 315.6"));
    assertTrue(isViralName("bacteriophages"));
    assertTrue(isViralName("\"T1-like viruses\""));
    // http://dev.gbif.org/issues/browse/PF-2574
    assertTrue(isViralName("Inachis io NPV"));
    assertTrue(isViralName("Hyloicus pinastri NPV"));
    assertTrue(isViralName("Dictyoploca japonica NPV"));
    assertTrue(isViralName("Apocheima pilosaria NPV"));
    assertTrue(isViralName("Lymantria xylina NPV"));
    assertTrue(isViralName("Feltia subterranea GV"));
    assertTrue(isViralName("Dionychopus amasis GV"));

    assertFalse(isViralName("Forcipomyia flavirustica Remm, 1968"));

  }

  public boolean isViralName(String name) {
    try {
      ParsedName pn = parser.parse(name, null);
    } catch (UnparsableNameException e) {
      // swallow
      if (NameType.VIRUS == e.getType()) {
        return true;
      }
    }
    return false;
  }



  // **************
  // HELPER METHODS
  // **************


  private void assertEmptyName(String name) {
    assertUnparsableName(name, NO_NAME, null);
  }

  private void assertNoName(String name) {
    assertUnparsable(name, NO_NAME);
  }

  private void assertUnparsable(String name, NameType type) {
    assertUnparsableName(name, type, name);
  }

  private void assertUnparsableName(String name, NameType type, String expectedName) {
    try {
      parser.parse(name);
      fail("Expected "+name+" to be unparsable");

    } catch (UnparsableNameException ex) {
      assertEquals(type, ex.getType());
      assertEquals(expectedName, ex.getName());
    }
  }

  static NameAssertion assertName(String rawName, String expectedCanonicalWithoutAuthors) throws UnparsableNameException {
    return assertName(rawName, null, expectedCanonicalWithoutAuthors);
  }

  static NameAssertion assertName(String rawName, Rank rank, String expectedCanonicalWithoutAuthors) throws UnparsableNameException {
    ParsedName n = parser.parse(rawName, rank);
    assertEquals(expectedCanonicalWithoutAuthors, n.canonicalNameWithoutAuthorship());
    return new NameAssertion(n);
  }

  private BufferedReader resourceReader(String resourceFileName) throws UnsupportedEncodingException {
    return new BufferedReader(new InputStreamReader(getClass().getResourceAsStream("/" + resourceFileName), "UTF-8"));
  }

}